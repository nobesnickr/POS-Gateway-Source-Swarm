<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (c) 2013 Sonrisa Informatikai Kft. All Rights Reserved. This 
    software is the confidential and proprietary information of Sonrisa Informatikai 
    Kft. ("Confidential Information"). You shall not disclose such Confidential 
    Information and shall use it only in accordance with the terms of the license 
    agreement you entered into with Sonrisa. SONRISA MAKES NO REPRESENTATIONS 
    OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, EITHER EXPRESS OR IMPLIED, 
    INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS 
    FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. SONRISA SHALL NOT BE LIABLE 
    FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, MODIFYING OR DISTRIBUTING 
    THIS SOFTWARE OR ITS DERIVATIVES. -->
             
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">


    <changeSet id="20130715_2033" author="joe">
        <preConditions onFail="MARK_RAN">
            <dbms type="MYSQL" />
            <not>
                <tableExists tableName="BATCH_JOB_EXECUTION" />
            </not>
        </preConditions>
        <sqlFile splitStatements="true" stripComments="true"
            encoding="UTF-8"
            path="classpath:org/springframework/batch/core/schema-mysql.sql"
            relativeToChangelogFile="false" />
    </changeSet>

    <changeSet id="20130716_2033" author="beci">
        <preConditions onFail="MARK_RAN">
            <dbms type="H2" />
            <not>
                <tableExists tableName="BATCH_JOB_EXECUTION" />
            </not>
        </preConditions>
        <sqlFile splitStatements="true" stripComments="true"
            encoding="UTF-8"
            path="classpath:org/springframework/batch/core/schema-h2.sql"
            relativeToChangelogFile="false" />
    </changeSet>

    <changeSet author="generated" id="20131203_1200">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="staging_invoices" />
            </not>
        </preConditions>
        
        <comment>Autogenerated script</comment>
        
        <createTable tableName="retailpro_client">
            <column autoIncrement="true" name="id" type="INT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="component_id" type="VARCHAR(20)" />
            <column name="component_type" type="VARCHAR(20)" />
            <column name="rp_version" type="VARCHAR(20)" />
            <column name="comments" type="VARCHAR(50)" />
            <column name="install_date" type="DATETIME" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="modified_at" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="created_at" type="DATETIME" />
        </createTable>
        <createTable tableName="retailpro_configuration">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="swarm_id" type="VARCHAR(255)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="ts" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="invoice_date" type="DATETIME" />
            <column name="store_date" type="DATETIME" />
            <column name="version_date" type="DATETIME" />
            <column name="author" type="VARCHAR(100)" />
            <column name="comment" type="VARCHAR(255)" />
        </createTable>
        <createTable tableName="retailpro_plugin">
            <column autoIncrement="true" name="id" type="INT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="heartbeat" type="DATETIME" />
            <column name="plugin_version" type="VARCHAR(20)" />
        </createTable>
  
        <createTable tableName="staging_categories">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="ls_category_id" type="VARCHAR(100)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="stage_created_at" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="store_id" type="VARCHAR(100)" />
            <column name="parent_id" type="VARCHAR(100)" />
            <column name="name" type="VARCHAR(100)" />
            <column name="ls_lft" type="VARCHAR(100)" />
            <column name="ls_rgt" type="VARCHAR(100)" />
            <column name="last_modified" type="VARCHAR(20)" />
        </createTable>
        <createTable tableName="staging_customers">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="ls_store_no" type="VARCHAR(100)" />
            <column name="ls_sbs_no" type="VARCHAR(100)" />
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="ls_customer_id" type="VARCHAR(100)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="stage_created_at" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="name" type="VARCHAR(100)" />
            <column name="firstname" type="VARCHAR(50)" />
            <column name="lastname" type="VARCHAR(50)" />
            <column name="email" type="VARCHAR(100)" />
            <column name="phone" type="VARCHAR(20)" />
            <column name="address1" type="VARCHAR(100)" />
            <column name="address2" type="VARCHAR(100)" />
            <column name="city" type="VARCHAR(50)" />
            <column name="state" type="CHAR(2)" />
            <column name="notes" type="TEXT" />
            <column name="store_id" type="BIGINT UNSIGNED" />
            <column name="last_modified" type="VARCHAR(40)" />
        </createTable>
        <createTable tableName="staging_invoice_lines">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="ls_invoice_id" type="VARCHAR(100)" />
            <column name="ls_line_id" type="VARCHAR(100)" />
            <column name="ls_product_id" type="VARCHAR(100)" />
            <column name="swarm_id" type="VARCHAR(255)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="stage_created_at" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="quantity" type="VARCHAR(10)" />
            <column name="price" type="VARCHAR(20)" />
            <column name="tax" type="VARCHAR(10)" />
            <column name="store_id" type="BIGINT UNSIGNED" />
            <column name="ls_store_no" type="VARCHAR(100)" />
            <column name="ls_sbs_no" type="VARCHAR(100)" />
        </createTable>
        <createTable tableName="staging_invoices">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="ls_store_no" type="VARCHAR(100)" />
            <column name="ls_sbs_no" type="VARCHAR(100)" />
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="ls_invoice_id" type="VARCHAR(100)" />
            <column name="ls_customer_id" type="VARCHAR(100)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="stage_created_at" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="invoice_no" type="VARCHAR(50)" />
            <column name="ts" type="VARCHAR(40)" />
            <column name="total" type="VARCHAR(20)" />
            <column name="store_id" type="BIGINT UNSIGNED" />
        </createTable>
        <createTable tableName="staging_products">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="ls_product_id" type="VARCHAR(100)" />
            <column name="ls_store_no" type="VARCHAR(100)" />
            <column name="ls_sbs_no" type="VARCHAR(100)" />
            <column name="swarm_id" type="VARCHAR(255)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="stage_created_at" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="sku" type="VARCHAR(50)" />
            <column name="store_sku" type="VARCHAR(50)" />
            <column name="category" type="VARCHAR(100)" />
            <column name="manufacturer" type="VARCHAR(50)" />
            <column name="upc" type="VARCHAR(14)" />
            <column name="ean" type="VARCHAR(14)" />
            <column name="description" type="VARCHAR(250)" />
            <column name="price" type="VARCHAR(20)" />
            <column name="last_modified" type="VARCHAR(40)" />
            <column name="store_id" type="BIGINT UNSIGNED" />
            <column name="ls_manufacturer_id" type="BIGINT UNSIGNED" />
            <column name="ls_category_id" type="BIGINT UNSIGNED" />
        </createTable>
        <createTable tableName="stores_rp">
            <column autoIncrement="true" name="id" type="INT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="ls_store_no" type="VARCHAR(100)" />
            <column name="ls_sbs_no" type="VARCHAR(100)" />
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="store_name" type="VARCHAR(255)" />
            <column name="store_id" type="BIGINT" />
            <column name="timezone" type="VARCHAR(50)" />
            <column name="time_offset" type="BIGINT" />
        </createTable>
        <createIndex indexName="UK_RETAILPRO_CLIENT_SWARM_ID_AND_COMPONENT_ID"
            tableName="retailpro_client" unique="true">
            <column name="swarm_id" />
            <column name="component_id" />
        </createIndex>
        <createIndex indexName="UK_RETAILPRO_PLUGIN_SWARM_ID"
            tableName="retailpro_plugin" unique="true">
            <column name="swarm_id" />
        </createIndex>
    </changeSet>
    
    <changeSet id="20131205_1313" author="joe">
        <comment>Add index to the stores_rp table to help the execution of the query that returns the staging 
            invoices for staging loader job.</comment>
        <createIndex tableName="stores_rp" indexName="RP_STORE_IDENTIFIERS">
            <column name="swarm_id"/>
            <column name="ls_store_no"/>
            <column name="ls_sbs_no"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="20130930_1223" author="barna">
        <comment> Creation of STAGING_MANUFACTURERS, a table that serves as the staging table for manufacturers.</comment>
        <createTable tableName="staging_manufacturers">
            <column name="id" type="BIGINT(20)" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="store_id" type="BIGINT(20)" />
            <column name="ls_manufacturer_id" type="varchar(100)" />
            <column name="stage_created_at" type="TIMESTAMP"
                defaultValueComputed="CURRENT_TIMESTAMP"></column>
            <column name="name" type="VARCHAR(100)" />
            <column name="last_modified" type="varchar(20)" />
        </createTable>
    </changeSet>
    
    
    <changeSet id="20140103_1816" author="barna">
    	<comment>Fill in the completed field for invoices received from Merchant OS</comment>
    	<addColumn tableName="staging_invoices">
        	<column name="completed" type="VARCHAR(31)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    
    <changeSet id="20140110_1004" author="barna">
    	<comment>Retail Pro V9 integration</comment>
    	<addColumn tableName="stores_rp">
        	<column name="pos_software" type="VARCHAR(255)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20140112_1534" author="barna">
    	<comment>Stores should be able to upload locale information</comment>
    	<addColumn tableName="stores_rp">
        	<column name="pos_timezone" type="VARCHAR(255)" defaultValueComputed="NULL"/>
        	<column name="notes" type="VARCHAR(255)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20140127_11112" author="barna">
    	<comment>Staging invoices should have additional information from Retail Pro to help filter out invalid invoices.</comment>
    	<addColumn tableName="staging_invoices">
    		<column name="so_number" type="VARCHAR(100)" defaultValueComputed="NULL"/>
        	<column name="receipt_type" type="VARCHAR(20)" defaultValueComputed="NULL"/>
        	<column name="receipt_status" type="VARCHAR(20)" defaultValueComputed="NULL"/>
        	<column name="tender" type="VARCHAR(20)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
   <changeSet id="20140314_1654" author="barna">
        <comment>Adds last modified column to staging_invoices for Shopify fix.</comment>
         <addColumn tableName="staging_invoices">
        	<column name="last_modified" type="varchar(255)"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20140521_1326" author="barna">
    	<comment>Fill in the linesProcessed field for Kounta invoices</comment>
    	<addColumn tableName="staging_invoices">
        	<column name="lines_processed" type="VARCHAR(31)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
   <changeSet id="20140428_1512" author="barna">
    	<comment>Adding created column to the stores_rp table makes the administrative module simpler</comment>
    	<addColumn tableName="stores_rp">
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="created" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
    	</addColumn>
    </changeSet>
    
    
    <changeSet id="20140708_1507" author="barna">
    	<comment>Retail Pro stores can be ignored the status page</comment>
    	<addColumn tableName="stores_rp">
        	<column name="state" type="VARCHAR(255)" defaultValueComputed="'NORMAL'"/>
    	</addColumn>
		<update tableName="stores_rp">
			<column name="state" type="VARCHAR(255)" value="NORMAL" />
		</update>
    </changeSet>
    
    <changeSet id="20141112_1127" author="carlos">
        <comment> Creation of STAGING_OUTLETS, a table that serves as the staging table for outlets.</comment>
        <createTable tableName="staging_outlets">
            <column name="id" type="BIGINT(20)" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="ls_outlet_id" type="BIGINT(20)" />
            <column name="store_id" type="BIGINT(20)" />
            <column name="name" type="varchar(50)" />
            <column name="address1" type="varchar(50)" />
            <column name="address2" type="varchar(50)" />
            <column name="city" type="varchar(50)" />
            <column name="state" type="varchar(50)" />
            <column name="postcode" type="varchar(15)" />
            <column name="country" type="varchar(50)" />
            <column name="firstname" type="varchar(50)" />
            <column name="lastname" type="varchar(50)" />
            <column name="email" type="varchar(100)" />
            <column name="phone" type="varchar(50)" />
            <column name="fax" type="varchar(50)" />
            <column name="website" type="varchar(255)" />
            <column name="uuid" type="varchar(36)" />
            <column name="last_modified" type="TIMESTAMP"/>
        </createTable>
    </changeSet>
    
    <changeSet id="20141119_1159" author="carlos">
        <comment> Creation of staging_registers, a table that serves as the staging table for registers.</comment>
        <createTable tableName="staging_registers">
            <column name="id" type="BIGINT(20)" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="register_id" type="BIGINT(20)"/>
            <column name="swarm_id" type="VARCHAR(255)" />
            <column name="ls_register_id" type="BIGINT(20)" />
            <column name="store_id" type="BIGINT(20)" />
            <column name="outlet_id" type="BIGINT(20)" />
            <column name="ls_outlet_id" type="BIGINT(20)" />
            <column name="name" type="varchar(50)" />
            <column name="uuid" type="varchar(36)" />
            <column name="last_modified" type="TIMESTAMP"/>
        </createTable>
    </changeSet>
    
    <changeSet id="20141121_1157" author="carlos">
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="staging_customers">
        	<column name="postcode" type="VARCHAR(15)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141124_0143" author="carlos">
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="staging_invoices">
        	<column name="ls_outlet_id" type="VARCHAR(100)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141124_0145" author="carlos">
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="staging_invoices">
        	<column name="ls_register_id" type="VARCHAR(100)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141124_0150" author="carlos">
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="staging_invoices">
        	<column name="outlet_id" type="VARCHAR(100)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141124_0155" author="carlos">
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="staging_invoices">
        	<column name="register_id" type="VARCHAR(100)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141124_1428" author="carlos">
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="staging_invoice_lines">
        	<column name="description" type="VARCHAR(255)"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141124_1429" author="carlos">
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="staging_invoice_lines">
        	<column name="ts" type="TIMESTAMP"/>
    	</addColumn>
    </changeSet>
</databaseChangeLog>
