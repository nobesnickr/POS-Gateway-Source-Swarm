<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (c) 2013 Sonrisa Informatikai Kft. All Rights Reserved. This 
    software is the confidential and proprietary information of Sonrisa Informatikai 
    Kft. ("Confidential Information"). You shall not disclose such Confidential 
    Information and shall use it only in accordance with the terms of the license 
    agreement you entered into with Sonrisa. SONRISA MAKES NO REPRESENTATIONS 
    OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, EITHER EXPRESS OR IMPLIED, 
    INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS 
    FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. SONRISA SHALL NOT BE LIABLE 
    FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, MODIFYING OR DISTRIBUTING 
    THIS SOFTWARE OR ITS DERIVATIVES. -->


<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<changeSet id="20141112_1121" author="carlos">
        <comment> Creation of OUTLETS, a table that serves to store outlets.</comment>
        <createTable tableName="outlets">
            <column name="outlet_id" type="BIGINT(20)" autoIncrement="true">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="ls_outlet_id" type="BIGINT(20)" />
            <column name="store_id" type="BIGINT(20)" />
            <column name="name" type="varchar(50)" />
            <column name="address1" type="varchar(50)" />
            <column name="address2" type="varchar(50)" />
            <column name="city" type="varchar(50)" />
            <column name="state" type="varchar(50)" />
            <column name="postcode" type="varchar(15)" />
            <column name="country" type="varchar(50)" />
            <column name="firstname" type="varchar(50)" />
            <column name="lastname" type="varchar(50)" />
            <column name="email" type="varchar(100)" />
            <column name="phone" type="varchar(50)" />
            <column name="fax" type="varchar(50)" />
            <column name="website" type="varchar(255)" />
            <column name="uuid" type="varchar(36)">
            </column>
        </createTable>
    </changeSet>
    
    <changeSet id="20141218_1008" author="carlos">
        <preConditions onFail="MARK_RAN">
            <not>
                <dbms type="h2" />
            </not>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.triggers 
                WHERE trigger_name LIKE 'outlets_uuid_trigger';
            </sqlCheck>
        </preConditions>
        <sql splitStatements="false">
            CREATE TRIGGER outlets_uuid_trigger
            BEFORE INSERT ON outlets
            FOR EACH ROW
                BEGIN
                    IF new.uuid IS NULL THEN SET new.uuid=uuid();
                    END IF;
                END;
        </sql>
    </changeSet>

    <changeSet author="generated" id="20141112_1154">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="invoices" />
            </not>
        </preConditions>
        
        <comment>Autogenerated script</comment>
        
        <createTable tableName="apis">
            <column autoIncrement="true" name="api_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(50)" />
            <column name="notes" type="TEXT" />
        </createTable>
        <createTable tableName="categories">
            <column autoIncrement="true" name="category_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="store_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column defaultValueNumeric="0" name="ls_category_id"
                type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="parent_id" type="BIGINT UNSIGNED" />
            <column name="name" type="VARCHAR(100)" />
            <column name="lft" type="BIGINT UNSIGNED" />
            <column name="rgt" type="BIGINT UNSIGNED" />
            <column name="last_modified" type="TIMESTAMP" />
        </createTable>
        <createTable tableName="customers">
            <column autoIncrement="true" name="customer_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column defaultValueNumeric="0" name="ls_customer_id"
                type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column defaultValueNumeric="0" name="store_id"
                type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="name" type="VARCHAR(100)" />
            <column name="firstname" type="VARCHAR(50)" />
            <column name="lastname" type="VARCHAR(50)" />
            <column name="email" type="VARCHAR(100)" />
            <column name="phone" type="VARCHAR(20)" />
            <column name="address1" type="VARCHAR(100)" />
            <column name="address2" type="VARCHAR(100)" />
            <column name="city" type="VARCHAR(50)" />
            <column name="state" type="CHAR(2)" />
            <column name="notes" type="TEXT" />
            <column name="last_modified" type="DATETIME" />
            <column name="uuid" type="CHAR(36)" />
        </createTable>
        <createTable tableName="error_log">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="store_id" type="BIGINT UNSIGNED" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="ts" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="error" type="VARCHAR(100)" />
            <column name="details" type="TEXT" />
        </createTable>
        <createTable tableName="invoice_lines">
            <column autoIncrement="true" name="invoice_line_id"
                type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="invoice_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column defaultValueNumeric="0" name="ls_line_id"
                type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="ls_product_id" type="BIGINT" />
            <column name="code" type="VARCHAR(100)" />
            <column name="description" type="VARCHAR(255)" />
            <column name="class" type="VARCHAR(100)" />
            <column name="family" type="VARCHAR(100)" />
            <column name="quantity" type="SMALLINT UNSIGNED" />
            <column name="price" type="DECIMAL(8,2)" />
            <column name="tax" type="DECIMAL(8,2)" />
            <column name="ts" type="TIMESTAMP" />
            <column defaultValueNumeric="0" name="store_id"
                type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createTable tableName="invoices">
            <column autoIncrement="true" name="invoice_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="store_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column defaultValueNumeric="0" name="ls_invoice_id"
                type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="customer_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="invoice_no" type="VARCHAR(50)" />
            <column defaultValue="0000-00-00 00:00:00" name="ts"
                type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="tsfraction" type="INT" />
            <column name="name" type="VARCHAR(100)" />
            <column name="mainphone" type="VARCHAR(50)" />
            <column name="email" type="VARCHAR(100)" />
            <column name="total" type="DECIMAL(8,2)" />
            <column defaultValueBoolean="false" name="completed"
                type="BIT" />
            <column name="lines_processed" type="BIT" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="test_ts" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="outlet_id" type="BIGINT UNSIGNED" />
        </createTable>
        <createTable tableName="invoices_for_deletion">
            <column autoIncrement="true" name="invoice_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="store_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="ls_invoice_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="customer_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="invoice_no" type="VARCHAR(50)" />
            <column defaultValue="0000-00-00 00:00:00" name="ts"
                type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="tsfraction" type="INT" />
            <column name="name" type="VARCHAR(100)" />
            <column name="mainphone" type="VARCHAR(50)" />
            <column name="email" type="VARCHAR(100)" />
            <column name="total" type="DECIMAL(8,2)" />
            <column defaultValueBoolean="false" name="completed"
                type="BIT" />
            <column name="lines_processed" type="BIT" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="test_ts" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createTable tableName="manufacturers">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column defaultValueNumeric="0" name="store_id"
                type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column defaultValueNumeric="0" name="manufacturer_id"
                type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="name" type="VARCHAR(100)" />
            <column name="last_modified" type="TIMESTAMP" />
        </createTable>
        <createTable tableName="products">
            <column autoIncrement="true" name="product_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column defaultValueNumeric="0" name="ls_product_id"
                type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column defaultValueNumeric="0" name="store_id"
                type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="sku" type="VARCHAR(50)" />
            <column name="store_sku" type="VARCHAR(50)" />
            <column name="category" type="VARCHAR(100)" />
            <column name="manufacturer" type="VARCHAR(50)" />
            <column name="upc" type="VARCHAR(14)" />
            <column name="ean" type="VARCHAR(14)" />
            <column name="description" type="VARCHAR(250)" />
            <column name="price" type="DECIMAL(8,2)" />
            <column name="last_modified" type="TIMESTAMP" />
        </createTable>
        <createTable tableName="stores">
            <column autoIncrement="true" name="store_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="api_id" type="BIGINT UNSIGNED" />
            <column name="name" type="VARCHAR(100)" />
            <column name="api_url" type="VARBINARY(256)" />
            <column name="api_key" type="VARBINARY(112)" />
            <column name="username" type="VARBINARY(112)" />
            <column name="password" type="VARBINARY(256)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="created" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="active" type="BIT" />
            <column name="notes" type="TEXT" />
            <column name="tz" type="CHAR(64)" />
            <column name="account_id" type="BIGINT UNSIGNED" />
            <column name="store_filter" type="VARCHAR(100)" />
        </createTable>
        <createTable tableName="stores_encrypted">
            <column autoIncrement="true" name="store_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="api_id" type="BIGINT UNSIGNED" />
            <column name="name" type="VARCHAR(100)" />
            <column name="api_url" type="VARBINARY(256)" />
            <column name="api_key" type="VARBINARY(112)" />
            <column name="username" type="VARBINARY(112)" />
            <column name="password" type="VARBINARY(256)" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="created" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="active" type="BIT" />
            <column name="notes" type="TEXT" />
            <column name="tz" type="CHAR(64)" />
        </createTable>
        <createTable tableName="updates">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="store_id" type="BIGINT UNSIGNED" />
            <column defaultValueComputed="CURRENT_TIMESTAMP"
                name="start_time" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
            <column name="end_time" type="TIMESTAMP" />
            <column defaultValueNumeric="0" name="imported" type="INT">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createTable tableName="vend_ids">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="account_id" type="BIGINT UNSIGNED">
                <constraints nullable="false" />
            </column>
            <column name="type" type="VARCHAR(15)" />
            <column name="uuid" type="CHAR(36)" />
        </createTable>
        <createIndex indexName="UK_apis_id" tableName="apis"
            unique="true">
            <column name="api_id" />
        </createIndex>
        <createIndex indexName="UK_categories_category_id"
            tableName="categories" unique="true">
            <column name="category_id" />
        </createIndex>
        <createIndex indexName="UK_customers_id" tableName="customers"
            unique="true">
            <column name="customer_id" />
        </createIndex>
        <createIndex indexName="UK_error_log_id" tableName="error_log"
            unique="true">
            <column name="id" />
        </createIndex>
        <createIndex indexName="UK_invoice_lines_id"
            tableName="invoice_lines" unique="true">
            <column name="invoice_line_id" />
        </createIndex>
        <createIndex indexName="UK_invoices_invoice_id"
            tableName="invoices" unique="true">
            <column name="invoice_id" />
        </createIndex>
        <createIndex indexName="K_invoices_for_deletion_store_id"
            tableName="invoices_for_deletion" unique="false">
            <column name="store_id" />
        </createIndex>
        <createIndex indexName="UK_invoices_for_deletion_invoice_id"
            tableName="invoices_for_deletion" unique="true">
            <column name="invoice_id" />
        </createIndex>
        <createIndex indexName="UK_manufacturers_id"
            tableName="manufacturers" unique="true">
            <column name="id" />
        </createIndex>
        <createIndex indexName="outlet_id" tableName="outlets"
            unique="true">
            <column name="outlet_id" />
        </createIndex>
        <createIndex indexName="uuid" tableName="outlets"
            unique="true">
            <column name="uuid" />
        </createIndex>
        <createIndex indexName="UK_products_product_id"
            tableName="products" unique="true">
            <column name="product_id" />
        </createIndex>
        <createIndex indexName="UK_stores_store_id"
            tableName="stores" unique="true">
            <column name="store_id" />
        </createIndex>
        <createIndex indexName="UK_stores_encrypted_store_id"
            tableName="stores_encrypted" unique="true">
            <column name="store_id" />
        </createIndex>
        <createIndex indexName="UK_updates_id" tableName="updates"
            unique="true">
            <column name="id" />
        </createIndex>
        <createIndex indexName="UK_vend_ids_id" tableName="vend_ids"
            unique="true">
            <column name="id" />
        </createIndex>
        <createIndex indexName="UK_vend_ids_uuid" tableName="vend_ids"
            unique="true">
            <column name="uuid" />
        </createIndex>
        <dropPrimaryKey tableName="categories" />
        <addPrimaryKey columnNames="store_id, ls_category_id"
            tableName="categories" />
        <dropPrimaryKey tableName="customers" />
        <addPrimaryKey columnNames="store_id, ls_customer_id"
            tableName="customers" />
        <dropPrimaryKey tableName="invoice_lines" />
        <addPrimaryKey columnNames="ls_line_id, store_id"
            tableName="invoice_lines" />
        <dropPrimaryKey tableName="invoices" />
        <addPrimaryKey columnNames="store_id, ls_invoice_id"
            tableName="invoices" />
        <dropPrimaryKey tableName="manufacturers" />
        <addPrimaryKey columnNames="store_id, manufacturer_id"
            tableName="manufacturers" />
        <dropPrimaryKey tableName="products" />
        <addPrimaryKey columnNames="store_id, ls_product_id"
            tableName="products" />
        <addForeignKeyConstraint
            baseColumnNames="invoice_id" baseTableName="invoice_lines"
            constraintName="invoice_lines_ibfk_1" deferrable="false"
            initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION"
            referencedColumnNames="invoice_id" referencedTableName="invoices"
            referencesUniqueColumn="false" />
        <addForeignKeyConstraint
            baseColumnNames="store_id" baseTableName="invoices"
            constraintName="invoices_ibfk_1" deferrable="false"
            initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION"
            referencedColumnNames="store_id" referencedTableName="stores"
            referencesUniqueColumn="false" />
        <createIndex indexName="UK_apis_api_id" tableName="apis"
            unique="true">
            <column name="api_id" />
        </createIndex>
    </changeSet>
    
    <changeSet id="20141015_1008" author="joe">
        <preConditions onFail="MARK_RAN">
            <not>
                <dbms type="h2" />
            </not>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.triggers 
                WHERE trigger_name LIKE 'customers_uuid_trigger';
            </sqlCheck>
        </preConditions>
        <sql splitStatements="false">
            CREATE TRIGGER customers_uuid_trigger
            BEFORE INSERT ON customers
            FOR EACH ROW
                BEGIN
                    IF new.uuid IS NULL THEN SET new.uuid=uuid();
                    END IF;
                END;
        </sql>
    </changeSet>


    <changeSet id="20141121_1208" author="carlos">
    	<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="customers" columnName="postcode"/>
            </not>
        </preConditions>
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="customers">
        	<column name="postcode" type="VARCHAR(15)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>

    <changeSet id="20131203_1554" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select count(*) from apis
                where name LIKE 'ERPLY'</sqlCheck>
        </preConditions>
        <comment>Renames Erply API name to lowercase.</comment>
         <sql>
            UPDATE apis SET name='erply' WHERE name='ERPLY';
        </sql>
    </changeSet>

    <changeSet id="20130809" author="joe">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis
                where name LIKE 'erply' OR name like 'ERPLY'</sqlCheck>
        </preConditions>
        <comment>Inserts the Erply as an API.</comment>
        <insert tableName="apis">
            <column name="name" value="erply" />
        </insert>
    </changeSet>

    <changeSet id="20131002_1521" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis
                where name LIKE 'merchantos'</sqlCheck>
        </preConditions>
        <comment>Inserts the Merchantos as an API.</comment>
        <insert tableName="apis">
            <column name="name" value="merchantos" />
        </insert>
    </changeSet>
    
    <changeSet id="20131203_1556" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select count(*) from apis
                where name LIKE 'RetailPro8'</sqlCheck>
        </preConditions>
        <comment>Renames RetailPro V8 API name to lowercase.</comment>
         <sql>
            UPDATE apis SET name='retailpro8' WHERE name='RetailPro8';
        </sql>
    </changeSet>

    <changeSet id="20131022_1146" author="joe">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis
                where name LIKE 'retailpro8' OR name LIKE 'RetailPro8'</sqlCheck>
        </preConditions>
        <comment>Inserts the RetailPro v8 API.</comment>
        <insert tableName="apis">
            <column name="name" value="retailpro8" />
        </insert>
    </changeSet>
    
    <changeSet id="20141218" author="carlos">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis
                where name LIKE 'vend' OR name like 'VEND'</sqlCheck>
        </preConditions>
        <comment>Inserts Vend as an API.</comment>
        <insert tableName="apis">
            <column name="name" value="vend" />
        </insert>
    </changeSet>
    
    <changeSet id="20131002_1232" author="barna">
    	<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="stores" columnName="oauth_token"/>
            </not>
        </preConditions>
        <comment>OAuth token added to Stores table for Merchant OS</comment>
        <sql>
            ALTER TABLE stores ADD COLUMN oauth_token VARBINARY(256)
        </sql>
    </changeSet> 
    
    <changeSet id="20131216_1535" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis where name LIKE 'shopify'</sqlCheck>
        </preConditions>
        <comment>Inserts the Shopify API.</comment>
        <insert tableName="apis">
            <column name="name" value="shopify" />
        </insert>
    </changeSet>
    
    
    <changeSet id="20140110_1006" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis where name LIKE 'retailpro9'</sqlCheck>
        </preConditions>
        <comment>Inserts the Retail Pro V9 api.</comment>
        <insert tableName="apis">
            <column name="name" value="retailpro9" />
        </insert>
    </changeSet>
    
    <changeSet id="20140114_1414" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis where name LIKE 'merchantos_gw'</sqlCheck>
        </preConditions>
        <comment>Inserts the api entry for the Gateway managed Merchant OS stores.</comment>
        <insert tableName="apis">
            <column name="name" value="merchantos_gw" />
        </insert>
    </changeSet>
    
    <changeSet id="20140120_1008" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis where name LIKE 'revel'</sqlCheck>
        </preConditions>
        <comment>Inserts the api entry for Revel Systems stores.</comment>
        <insert tableName="apis">
            <column name="name" value="revel" />
        </insert>
    </changeSet>
    
    <changeSet id="20140121_1044" author="barna">
        <preConditions onFail="MARK_RAN">
              <columnExists columnName="id" tableName="manufacturers"/>
        </preConditions>
        <comment>Legacy schema was changed (id->manufacturer_id, manufacturer_id -> ls_manufacturer_id). This changeset will not run in the production environment.</comment>
        <renameColumn
            columnDataType="BIGINT UNSIGNED"
            newColumnName="ls_manufacturer_id"
            oldColumnName="manufacturer_id"
            tableName="manufacturers"/>
            
         <renameColumn
            columnDataType="BIGINT UNSIGNED"
            newColumnName="manufacturer_id"
            oldColumnName="id"
            tableName="manufacturers"/>
    </changeSet>
    
    <changeSet id="20140304_1033" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis where name LIKE 'lightspeed_pro'</sqlCheck>
        </preConditions>
        <comment>Inserts the api entry for Lightspeed Pro stores.</comment>
        <insert tableName="apis">
            <column name="name" value="lightspeed_pro" />
        </insert>
    </changeSet>
    
    <changeSet id="20140314_1655" author="barna">
    	<preConditions onFail="MARK_RAN">
    		<not>
              <columnExists columnName="last_modified" tableName="invoices"/>
            </not>
        </preConditions>
        <comment>Adds last modified column to invoices for Shopify fix.</comment>
         <addColumn tableName="invoices">
        	<column name="last_modified" type="TIMESTAMP DEFAULT NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20140320_1334" author="barna">
    	<comment>Retail Pro customer ids are 64 bit integeres</comment>
        <sql>
         	ALTER TABLE invoices MODIFY COLUMN customer_id BIGINT(64); 
        </sql>
    </changeSet>
    
	<changeSet id="20140516_1443" author="barna">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis where name LIKE 'kounta'</sqlCheck>
        </preConditions>
        <comment>Inserts the api entry for Kounta stores.</comment>
        <insert tableName="apis">
            <column name="name" value="kounta" />
        </insert>
    </changeSet>

	<changeSet id="20140618_1713" author="barna">
		<comment>Tagging stores for administartion page</comment>
		<update tableName="apis">
			<column name="notes" type="TEXT" value="gateway-plugin" />
			<where>name IN ('revel', 'shopify', 'merchantos_gw', 'erply', 'lightspeed_pro', 'kounta')</where>
		</update>
	</changeSet>
    <changeSet id="20140519_0002" author="tamas">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from apis where lower(name) LIKE 'rics'</sqlCheck>
        </preConditions>
        <comment>Inserts RICS API.</comment>
        <insert tableName="apis">
            <column name="name" value="rics" />
        </insert>
    </changeSet>
	
	<changeSet id="20140630_1352" author="barna">
		<comment>Tagging RICS as a gateway API.</comment>
		<update tableName="apis">
			<column name="notes" type="TEXT" value="gateway-plugin" />
			<where>name = 'rics'</where>
		</update>
	</changeSet>
	
	<changeSet id="20141124_0144" author="carlos">
    	<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="invoices" columnName="ls_outlet_id"/>
            </not>
        </preConditions>
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="invoices">
        	<column name="ls_outlet_id" type="BIGINT(20)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141124_0146" author="carlos">
    	<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="invoices" columnName="ls_register_id"/>
            </not>
        </preConditions>
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="invoices">
        	<column name="ls_register_id" type="BIGINT(20)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>

    
    <changeSet id="20141124_0148" author="carlos">
    	<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="invoices" columnName="register_id"/>
            </not>
        </preConditions>
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="invoices">
        	<column name="register_id" type="BIGINT(20)" defaultValueComputed="NULL"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="20141201_1429" author="carlos">
    	<preConditions onFail="MARK_RAN">
    	    <dbms type="MYSQL" />
            <sqlCheck expectedResult="1">select count(*) from information_schema.COLUMNS 
				where TABLE_NAME='invoice_lines' 
				and COLUMN_TYPE LIKE '%unsigned%' 
				and COLUMN_NAME LIKE 'quantity'</sqlCheck>
        </preConditions>
    	<comment>Changing quantity from unsigned to signed</comment>
        <sql>
            ALTER TABLE invoice_lines CHANGE COLUMN quantity quantity INT(10) NULL DEFAULT NULL ;
        </sql>
    </changeSet>
    
        <changeSet id="20141211_1055" author="carlos">
    	<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="outlets" columnName="last_modified"/>
            </not>
        </preConditions>
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="outlets">
        	<column name="last_modified" type="TIMESTAMP"/>
    	</addColumn>
    </changeSet>
    
    
	<changeSet id="20141119_1049" author="carlos">
    	<preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="registers"/>
            </not>
        </preConditions>
        <comment> Creation of registers table that serves as the storage table for registers.</comment>
        <createTable tableName="registers">
            <column name="register_id" type="BIGINT(20)" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="store_id" type="BIGINT(20)" />
            <column name="ls_register_id" type="BIGINT(20)" />
            <column name="outlet_id" type="BIGINT(20)" />
            <column name="ls_outlet_id" type="BIGINT(20)" />
            <column name="name" type="varchar(50)" />
            <column name="uuid" type="varchar(36)" />
        </createTable>
    </changeSet>
    
    <changeSet id="20141119_1050" author="carlos">
    	<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="registers" columnName="last_modified"/>
            </not>
        </preConditions>
    	<comment>Adding column for vend migration</comment>
    	<addColumn tableName="registers">
        	<column name="last_modified" type="TIMESTAMP"/>
    	</addColumn>
    </changeSet>
</databaseChangeLog>
